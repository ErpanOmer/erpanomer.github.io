---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCollection, getEntry } from "astro:content";
import dayjs from "dayjs";
import utc from "dayjs/plugin/utc";
import { getPost, getRecentPosts, getPopularPosts, syncPost } from "@/lib/db";

import BlogStats from "@/components/BlogStats.astro";
import AuthorCard from "@/components/AuthorCard.astro";
import PostSidebarList from "@/components/PostSidebarList.astro";
import TableOfContents from "@/components/TableOfContents.astro";

// SSR Mode: fetch post dynamically based on slug param
const { slug } = Astro.params;
dayjs.extend(utc);

if (!slug) {
    return Astro.redirect("/blog");
}

const postEntry = await getEntry("blog", slug);

if (!postEntry) {
    return Astro.redirect("/blog");
}

// Fetch from DB to override metadata
const db = Astro.locals.runtime.env.BLOG_DB;
// Use visitorId from middleware for consistent tracking
const visitorId = Astro.locals.visitorId || "anonymous";
let dbPost = await getPost(db, slug, visitorId);

// Lazy Sync: If post doesn't exist in DB, insert it from frontmatter
if (!dbPost) {
    await syncPost(db, {
        slug,
        title: postEntry.data.title,
        description: postEntry.data.description,
        pubDate: postEntry.data.pubDate,
        lastModified: postEntry.data.lastModified,
        author: postEntry.data.author,
        cover: postEntry.data.cover,
        tags: postEntry.data.tags,
        draft: postEntry.data.draft ?? false,
    });
    // Optional: Valid dbPost object for immediate use (though fallback handles it)
    // dbPost = { ... }
}

// Merge: DB > Frontmatter
const title = dbPost?.title || postEntry.data.title;
const description = dbPost?.description || postEntry.data.description;
const pubDate = dbPost?.pub_date
    ? new Date(dbPost.pub_date)
    : postEntry.data.pubDate;
const lastModifiedVal = dbPost?.last_modified
    ? new Date(dbPost.last_modified)
    : postEntry.data.lastModified;
const author = dbPost?.author || postEntry.data.author;
const cover = dbPost?.cover || postEntry.data.cover;
const tags = dbPost?.tags ? JSON.parse(dbPost.tags) : postEntry.data.tags;

const recentPosts = await getRecentPosts(db, 3);
const popularPosts = await getPopularPosts(db, 3);

const { Content, remarkPluginFrontmatter, headings } = await postEntry.render();
const lastModifiedFormatted = dayjs(
    lastModifiedVal || remarkPluginFrontmatter.lastModified,
).format("YYYY-MM-DD HH:mm:ss");

const jsonLd = {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    headline: title,
    description: description,
    datePublished: pubDate.toISOString(),
    dateModified: lastModifiedVal
        ? dayjs(lastModifiedVal).toISOString()
        : pubDate.toISOString(),
    author: {
        "@type": "Person",
        name: author,
    },
    url: new URL(Astro.url.pathname, Astro.site).toString(),
    image: cover ? new URL(cover, Astro.site).toString() : undefined,
    mainEntityOfPage: {
        "@type": "WebPage",
        "@id": new URL(Astro.url.pathname, Astro.site).toString(),
    },
};
---

<BaseLayout
    title={title}
    description={description}
    image={cover}
    type="article"
    publishedTime={pubDate}
    tags={tags}
>
    <script
        type="application/ld+json"
        set:html={JSON.stringify(jsonLd)}
        slot="head"
    />

    <!-- 3-Column Layout Container -->
    <div
        class="max-w-[1280px] mx-auto px-4 sm:px-6 py-12 lg:py-16 grid grid-cols-1 lg:grid-cols-[60px_1fr_320px] gap-8 lg:gap-12"
    >
        <!-- Left Column: Actions (Sticky on Desktop) -->
        <div class="hidden lg:block relative">
            <div class="sticky top-32 flex flex-col gap-8 items-center">
                <a
                    href="/blog"
                    class="flex items-center justify-center w-12 h-12 rounded-full bg-white/5 border border-white/5 text-gray-400 hover:text-white hover:border-white/20 hover:bg-white/10 transition-all duration-300 mb-4 group"
                    title="Back to Blog"
                >
                    <svg
                        class="w-5 h-5 transform transition-transform"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        ><path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg
                    >
                </a>

                <BlogStats slug={slug} vertical={true} />
            </div>
        </div>

        <!-- Center Column: Content -->
        <article class="min-w-0">
            <!-- Mobile Back Link -->
            <a
                href="/blog"
                class="lg:hidden inline-flex items-center gap-2 text-sm text-gh-muted hover:text-white mb-8 transition-colors"
            >
                <svg
                    class="w-4 h-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    ><path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg
                >
                <span>Back to Blog</span>
            </a>

            <!-- Header -->
            <header>
                <h1
                    class="text-xl md:text-4xl font-extrabold text-white mb-6 leading-tight tracking-tight"
                >
                    {title}
                </h1>
                <div class="flex flex-wrap gap-2 gap-y-1 mb-4">
                    {
                        tags.length > 0 &&
                            tags.map((tag: string) => (
                                <span class="text-xs font-medium px-2 py-0.5 rounded text-indigo-400 bg-indigo-500/10 border border-indigo-500/20 uppercase tracking-wide">
                                    {tag}
                                </span>
                            ))
                    }
                </div>
                <div
                    class="flex items-center gap-2 text-sm text-gh-muted pb-6 lg:pb-8"
                >
                    <div class="flex items-center gap-2">
                        <div
                            class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold text-xs uppercase"
                        >
                            <img
                                src="https://res.cloudinary.com/dkh81cvyt/image/upload/c_limit,w_120/f_auto/q_auto/v1/avatar_zjw8rn.png"
                                alt={author}
                                loading="lazy"
                                class="rounded-full"
                            />
                        </div>
                        <span class="font-medium text-gray-300">{author}</span>
                    </div>
                    <span>·</span>
                    <span>{new Date(pubDate).toLocaleDateString("sv-SE")}</span>
                    <span>·</span>
                    <span>{remarkPluginFrontmatter.minutesRead}</span>
                </div>
            </header>

            <!-- Cover Image -->
            {
                cover && (
                    <div class="mb-6 md:mb-12 rounded-2xl overflow-hidden shadow-2xl ring-1 ring-white/10">
                        <img
                            src={cover}
                            alt={title}
                            class="w-full object-cover"
                            loading="eager"
                        />
                    </div>
                )
            }

            <!-- Content -->
            <div
                class="prose-blog prose prose-invert max-w-none prose-headings:font-bold prose-headings:tracking-tight prose-a:text-indigo-400 hover:prose-a:text-indigo-300 prose-img:rounded-xl"
            >
                <Content />
            </div>
        </article>

        <!-- Right Column: Sidebar (Sticky on Desktop) -->
        <div class="hidden lg:block relative">
            <div
                class="sticky top-24 max-h-[calc(100vh-6rem)] overflow-y-auto pr-4 custom-scrollbar"
            >
                <AuthorCard author={author} />
                <TableOfContents headings={headings} />
                <PostSidebarList title="Recent Posts" posts={recentPosts} />
                <div class="mt-12 pb-8">
                    <PostSidebarList
                        title="Popular Posts"
                        posts={popularPosts}
                    />
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Action Bar (Fixed Bottom) -->
    <div class="lg:hidden">
        <BlogStats slug={slug} vertical={false} />
    </div>

    <!-- Lightbox UI -->
    <div
        id="lightbox"
        class="fixed inset-0 z-50 hidden bg-black/90 backdrop-blur-sm transition-opacity duration-300 opacity-0"
        style="will-change: opacity;"
    >
        <div class="absolute top-4 right-4 z-50">
            <button
                id="lightbox-close"
                class="text-white/70 hover:text-white transition-colors p-2"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="32"
                    height="32"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                >
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="h-full w-full flex items-center justify-center px-4 py-24">
            <img
                id="lightbox-img"
                src=""
                alt="Lightbox preview"
                class="max-h-full max-w-full object-contain shadow-2xl rounded-sm transform scale-95 transition-transform duration-300"
                decoding="async"
                style="will-change: transform; backface-visibility: hidden;"
            />
        </div>
    </div>

    <style is:global>
        html {
            scroll-padding-top: 100px; /* Fix TOC anchor positioning */
        }
        /* Custom scrollbar for sidebar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        .custom-scrollbar:hover::-webkit-scrollbar-thumb {
            background-color: rgba(99, 102, 241, 0.3);
        }

        /* Optimization: Zoom cursor for blog images */
        .prose-blog img {
            cursor: zoom-in;
        }
    </style>

    <script is:inline>
        // Lightbox Logic
        document.addEventListener("DOMContentLoaded", () => {
            const lightbox = document.getElementById("lightbox");
            const lightboxImg = document.getElementById("lightbox-img");
            const closeBtn = document.getElementById("lightbox-close");
            const body = document.body;
            let isOpen = false;

            const openLightbox = (src) => {
                lightboxImg.src = src;
                lightbox.classList.remove("hidden");
                // Trigger reflow
                void lightbox.offsetWidth;
                lightbox.classList.remove("opacity-0");
                lightboxImg.classList.remove("scale-95");
                lightboxImg.classList.add("scale-100");
                body.style.overflow = "hidden"; // Prevent scrolling
                isOpen = true;
            };

            const closeLightbox = () => {
                lightbox.classList.add("opacity-0");
                lightboxImg.classList.remove("scale-100");
                lightboxImg.classList.add("scale-95");
                setTimeout(() => {
                    lightbox.classList.add("hidden");
                    lightboxImg.removeAttribute("src");
                    body.style.overflow = "";
                    isOpen = false;
                }, 300);
            };

            // Optimization: Event Delegation
            const contentContainer = document.querySelector(".prose-blog");
            if (contentContainer) {
                contentContainer.addEventListener("click", (e) => {
                    const target = e.target;
                    if (target.tagName === "IMG") {
                        e.preventDefault();
                        e.stopPropagation();
                        openLightbox(target.src);
                    }
                });
            }

            // Close listeners
            closeBtn.addEventListener("click", closeLightbox);

            lightbox.addEventListener("click", (e) => {
                if (
                    e.target === lightbox ||
                    e.target.parentElement === lightbox
                ) {
                    closeLightbox();
                }
            });

            document.addEventListener("keydown", (e) => {
                if (isOpen && e.key === "Escape") {
                    closeLightbox();
                }
            });
        });
    </script>
</BaseLayout>
